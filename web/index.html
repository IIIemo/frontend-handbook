<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Сетевые протоколы и веб-сервер | Frontend Handbook</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/frontend-handbook/assets/css/0.styles.77f35ebf.css" as="style"><link rel="preload" href="/frontend-handbook/assets/js/app.d98f21f9.js" as="script"><link rel="preload" href="/frontend-handbook/assets/js/2.c185984c.js" as="script"><link rel="prefetch" href="/frontend-handbook/assets/js/10.31c3d593.js"><link rel="prefetch" href="/frontend-handbook/assets/js/11.16c6f45f.js"><link rel="prefetch" href="/frontend-handbook/assets/js/12.a19d62e7.js"><link rel="prefetch" href="/frontend-handbook/assets/js/13.afa6d33f.js"><link rel="prefetch" href="/frontend-handbook/assets/js/14.aa3a8385.js"><link rel="prefetch" href="/frontend-handbook/assets/js/15.f96eb0c1.js"><link rel="prefetch" href="/frontend-handbook/assets/js/16.65a57654.js"><link rel="prefetch" href="/frontend-handbook/assets/js/17.37317869.js"><link rel="prefetch" href="/frontend-handbook/assets/js/18.f8691fb6.js"><link rel="prefetch" href="/frontend-handbook/assets/js/19.37ef8bfb.js"><link rel="prefetch" href="/frontend-handbook/assets/js/20.87143ae8.js"><link rel="prefetch" href="/frontend-handbook/assets/js/21.91445095.js"><link rel="prefetch" href="/frontend-handbook/assets/js/22.721e3f8f.js"><link rel="prefetch" href="/frontend-handbook/assets/js/23.172e64f9.js"><link rel="prefetch" href="/frontend-handbook/assets/js/24.21fdf63d.js"><link rel="prefetch" href="/frontend-handbook/assets/js/25.81c9da2e.js"><link rel="prefetch" href="/frontend-handbook/assets/js/26.41641794.js"><link rel="prefetch" href="/frontend-handbook/assets/js/27.e227917b.js"><link rel="prefetch" href="/frontend-handbook/assets/js/28.772f2c9d.js"><link rel="prefetch" href="/frontend-handbook/assets/js/29.2de18efb.js"><link rel="prefetch" href="/frontend-handbook/assets/js/3.870fa968.js"><link rel="prefetch" href="/frontend-handbook/assets/js/30.d708bbdf.js"><link rel="prefetch" href="/frontend-handbook/assets/js/31.951fd535.js"><link rel="prefetch" href="/frontend-handbook/assets/js/32.b70f7721.js"><link rel="prefetch" href="/frontend-handbook/assets/js/33.8932cd2a.js"><link rel="prefetch" href="/frontend-handbook/assets/js/34.d0eb5f53.js"><link rel="prefetch" href="/frontend-handbook/assets/js/35.89074688.js"><link rel="prefetch" href="/frontend-handbook/assets/js/36.28ccce4c.js"><link rel="prefetch" href="/frontend-handbook/assets/js/37.0abd7188.js"><link rel="prefetch" href="/frontend-handbook/assets/js/38.078fb9a1.js"><link rel="prefetch" href="/frontend-handbook/assets/js/39.5d6fae1b.js"><link rel="prefetch" href="/frontend-handbook/assets/js/4.9e8cdf1a.js"><link rel="prefetch" href="/frontend-handbook/assets/js/40.5139ae7c.js"><link rel="prefetch" href="/frontend-handbook/assets/js/41.d0c6e3d4.js"><link rel="prefetch" href="/frontend-handbook/assets/js/42.4a36d234.js"><link rel="prefetch" href="/frontend-handbook/assets/js/43.5868b0af.js"><link rel="prefetch" href="/frontend-handbook/assets/js/44.8b985177.js"><link rel="prefetch" href="/frontend-handbook/assets/js/45.b24a9da2.js"><link rel="prefetch" href="/frontend-handbook/assets/js/46.a00dfcb2.js"><link rel="prefetch" href="/frontend-handbook/assets/js/47.35c749d1.js"><link rel="prefetch" href="/frontend-handbook/assets/js/48.26ded2d3.js"><link rel="prefetch" href="/frontend-handbook/assets/js/49.faa6dba8.js"><link rel="prefetch" href="/frontend-handbook/assets/js/5.68b3a669.js"><link rel="prefetch" href="/frontend-handbook/assets/js/50.0c747894.js"><link rel="prefetch" href="/frontend-handbook/assets/js/6.d79e0350.js"><link rel="prefetch" href="/frontend-handbook/assets/js/7.e88a6ac3.js"><link rel="prefetch" href="/frontend-handbook/assets/js/8.4cae68c3.js"><link rel="prefetch" href="/frontend-handbook/assets/js/9.5c47c439.js">
    <link rel="stylesheet" href="/frontend-handbook/assets/css/0.styles.77f35ebf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend-handbook/" class="home-link router-link-active"><!----> <span class="site-name">Frontend Handbook</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>В первую очередь</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/typing/" class="sidebar-link">Десятипальцевая слепая печать</a></li><li><a href="/frontend-handbook/english/" class="sidebar-link">Английский язык</a></li><li><a href="/frontend-handbook/googling/" class="sidebar-link">Как правильно гуглить</a></li><li><a href="/frontend-handbook/copyright/" class="sidebar-link">Авторское право</a></li><li><a href="/frontend-handbook/web/" class="active sidebar-link">Сетевые протоколы и веб-сервер</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#что-происходит-при-http-запросе" class="sidebar-link">Что происходит при HTTP-запросе</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#tls-протокоn" class="sidebar-link">TLS-протокол</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#итого-по-установке-соединения" class="sidebar-link">Итого по установке соединения</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#назначение" class="sidebar-link">Назначение</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#http-запрос" class="sidebar-link">HTTP-запрос</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#http-ответ" class="sidebar-link">HTTP-ответ</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#методы-http-запросов" class="sidebar-link">Методы HTTP-запросов</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#коды-http-ответов" class="sidebar-link">Коды HTTP-ответов</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#загоnовки" class="sidebar-link">Заголовки</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#управnение-соединением-в-http1-1" class="sidebar-link">Управление соединением в HTTP1.1</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#примеры" class="sidebar-link">Примеры</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#запуск" class="sidebar-link">Запуск</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#файnы-которые-испоnьзует-веб-сервер" class="sidebar-link">Файлы, которые использует веб-сервер</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#процессы-веб-сервера" class="sidebar-link">Процессы веб-сервера</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#цикn-работы-воркер-процессов" class="sidebar-link">Цикл работы воркер-процессов</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#модуnьная-архитектура-сервера" class="sidebar-link">Модульная архитектура сервера</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#конфигурация-веб-сервера" class="sidebar-link">Конфигурация веб-сервера</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#приоритет-урnов-в-location" class="sidebar-link">Приоритет урлов в location</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#отдача-статических-документов" class="sidebar-link">Отдача статических документов</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#атрибуты-файnов-и-процессов" class="sidebar-link">Атрибуты файлов и процессов</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#модеnи-обработки-сетевых-соединений" class="sidebar-link">Модели обработки сетевых соединений</a></li><li class="sidebar-sub-header"><a href="/frontend-handbook/web/#протокоn-ssh" class="sidebar-link">Протокол SSH</a></li></ul></li><li><a href="/frontend-handbook/soft-skills/" class="sidebar-link">Коммуникация, управление (soft skills)</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Инструменты</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/editors/" class="sidebar-link">Редакторы и IDE</a></li><li><a href="/frontend-handbook/editors/phpstorm.html" class="sidebar-link">PHPStorm</a></li><li><a href="/frontend-handbook/cli/" class="sidebar-link">Командная строка</a></li><li><a href="/frontend-handbook/git/" class="sidebar-link">Распределенная система контроля версий, Git</a></li><li><a href="/frontend-handbook/git/essentials.html" class="sidebar-link">Git, основы</a></li><li><a href="/frontend-handbook/git/advanced.html" class="sidebar-link">Git, продвинутый уровень</a></li><li><a href="/frontend-handbook/git/questions.html" class="sidebar-link">Git, вопросы для самоконтроля</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Дизайн и верстка</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/design/" class="sidebar-link">Дизайн, интерфейсы, русский язык</a></li><li><a href="/frontend-handbook/html-and-css/" class="sidebar-link">HTML и CSS</a></li><li><a href="/frontend-handbook/fonts/" class="sidebar-link">Шрифты</a></li><li><a href="/frontend-handbook/bem/" class="sidebar-link">БЭМ</a></li><li><a href="/frontend-handbook/rwd/" class="sidebar-link">Responsive Web Design</a></li><li><a href="/frontend-handbook/email/" class="sidebar-link">Верстка писем</a></li><li><a href="/frontend-handbook/html-practice/" class="sidebar-link">Практические задания по верстке</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Мультимедиа</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/multimedia/graphics.html" class="sidebar-link">Графика</a></li><li><a href="/frontend-handbook/multimedia/video.html" class="sidebar-link">Видео</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JS: язык и программирование</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/javascript/" class="sidebar-link">JavaScript, основы</a></li><li><a href="/frontend-handbook/javascript/regexp.html" class="sidebar-link">Регулярные выражения</a></li><li><a href="/frontend-handbook/programming/" class="sidebar-link">Программирование</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JS: сборка и экосистема</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/build-and-bundle/" class="sidebar-link">Сборка и автоматизация</a></li><li><a href="/frontend-handbook/build-and-bundle/npm.html" class="sidebar-link">NPM</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JS: библиотеки и фреймворки</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/jquery/" class="sidebar-link">jQuery</a></li><li><a href="/frontend-handbook/jquery-ui/" class="sidebar-link">jQuery UI</a></li><li><a href="/frontend-handbook/vue/" class="sidebar-link">Vue.js</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Оптимизация и отладка</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/optimization/" class="sidebar-link">Оптимизация</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>PHP/MySQL</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/frontend-handbook/php/" class="sidebar-link">PHP для фронтенд-разработчика</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="сетевые-протокоnы-и-веб-сервер"><a href="#сетевые-протокоnы-и-веб-сервер" aria-hidden="true" class="header-anchor">#</a> Сетевые протоколы и веб-сервер</h1> <p>Статья подготовлена на основе разделов 1.6, 1.7 и 1.8 курса <a href="https://stepik.org/course/Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8-154" target="_blank" rel="noopener noreferrer">Web-технологии<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. В тексте вы найдете ссылки на соответствующие видео-лекции.</p> <h2 id="что-происходит-при-http-запросе"><a href="#что-происходит-при-http-запросе" aria-hidden="true" class="header-anchor">#</a> Что происходит при HTTP-запросе</h2> <p><a href="https://stepik.org/lesson/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D1%8B-14823/step/2?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4172" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Службы и сервисы, задействованные при работе с HTTP:</p> <ul><li>Браузер анализирует введенный URL и извлекает имя хоста (например, <code>ya.ru</code>).</li> <li>Используя систему DNS, браузер преобразует домен в ip адрес (<code>ya.ru</code> становится <code>87.250.250.242</code>).</li> <li>Устанавливает TCP соединение с web-сервером.</li> <li>Если протокол https, устанавливает TLS соединение поверх TCP.</li> <li>Формирует HTTP запрос, отправляет его.</li> <li>Получает HTTP-ответ с содержимым страницы (кодом HTML).</li> <li>Браузер закрывает соединение (для HTTP/1.0).</li> <li>Идет процесс парсинга и отображения документа.</li></ul> <p>С помощью утилиты <a href="https://ru.wikipedia.org/wiki/CURL" target="_blank" rel="noopener noreferrer"><code>curl</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, можно увидеть необработанные браузером запросы и ответы:</p> <div class="language-sh extra-class"><pre class="language-text"><code>curl academy.oggettoweb.ru --verbose
</code></pre></div><p>Результат будет примерно таким:</p> <div class="language-sh extra-class"><pre class="language-text"><code># Преобразование доменного имени в IP:
* Rebuilt URL to: academy.oggettoweb.ru/
*   Trying 89.208.146.92...
* TCP_NODELAY set
* Connected to academy.oggettoweb.ru (89.208.146.92) port 80 (#0)

# Нашли сервер по IP, делаем запрос:
&gt; GET / HTTP/1.1
&gt; Host: academy.oggettoweb.ru
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt; 

# Получаем ответ:
&lt; HTTP/1.1 200 OK
&lt; Server: nginx
&lt; Date: Thu, 07 Dec 2017 23:22:32 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 1163
&lt; Last-Modified: Thu, 14 Sep 2017 11:18:41 GMT
&lt; Connection: keep-alive
&lt; Vary: Accept-Encoding
&lt; X-Frame-Options: ALLOWALL
&lt; Accept-Ranges: bytes
&lt; 
&lt;!doctype html&gt;
&lt;html lang=&quot;ru&quot;&gt;
&lt;head&gt;
# ...и тут остальной html-код страницы.
</code></pre></div><p>Сетевые протоколы объединяются в стэк: одни предоставляют свои возможности другим:</p> <img src="/frontend-handbook/assets/img/http_stack.757a031b.png" style="max-width: 700px"> <p>Client HTTP/TLS — браузер
Client TCP/IP — ОС пользователя</p> <p>Server HTTP/TLS — веб-сервер
Server TCP/IP — ОС сервера</p> <p>Синие пунктирные стрелки — это не фактические вызовы. Мы не можем напрямую обратится к HTTP-сервера от клиента. Нужно спуститься по иерархии протоколов до IP (на самом деле еще ниже, IP это тоже надстройка над более низкоуровневыми протоколами).</p> <p>Говоря, что данные передаются по HTTP, мы подразумеваем, что используется стек протоколов.</p> <h3 id="dns"><a href="#dns" aria-hidden="true" class="header-anchor">#</a> DNS</h3> <p>DNS (Domain Name System) - это распределенная база данных, хранящая информацию о доменах, в первую очередь отображение доменных имен на IP
адреса машин, обслуживающих эти домены.</p> <p>DNS — пожалуй, самая высоконагруженная база данных в мире. Она распределена по многим серверам (разделена на части для снижения нагрузки).</p> <p>Пространство доменных имен:</p> <img src="/frontend-handbook/assets/img/dns_scheme.18f50771.png" style="max-width: 700px"> <p><code>.</code> — самый корневой домен. Его обычно опускают в адресах.</p> <p>База DNS разделена на зоны. Каждая зона обслуживается
одной организацией:</p> <img src="/frontend-handbook/assets/img/dns_zones.a2cc1423.png" style="max-width: 700px"> <p>Обработка DNS-запроса. Преобразование DNS в IP-адрес — это одна из функций ОС. Для этого в ОС нужен настроенный DNS-сервер в настройках интернета (зачастую предоставляет провайдер).</p> <img src="/frontend-handbook/assets/img/dns_to_ip.3440a3d1.png" style="max-width: 700px"> <p>Для получения IP-адреса <code>dobro.mail.ru</code> мы спрашиваем DNS-сервер провайдера. Он, в свою очередь, спрашивает корневой DNS-сервер (<code>2</code>), тот отдает ему адрес сервера <code>.ru</code>. Потом спрашиваем <code>.ru</code> и тот отдает адрес <code>mail.ru</code>. Спрашиваем <code>main.ru</code> и уже он отдает DNS-серверу провайдера IP-адрес <code>dobro.mail.ru</code>.</p> <p>То есть каждый DNS-сервер знает только про следующий уровень.</p> <p>Работает механизм кеширования на разных уровнях DNS-серверов, чтобы каждый раз не дергать корневой сервер и всю последовательность.</p> <p>DNS-сервер возвращает:</p> <ul><li>Адрес IPv4 или адрес IPv6. Смотря что прописано в базе DNS-сервера.</li> <li>Адреса DNS-серверов, обслуживающих данную зону (NS)</li> <li>Адреса почтовых серверов для данного домена (MX)</li></ul> <p>Пример маршрута между DNS-серверами разного уровня: <code>traceroute ya.ru</code></p> <p>В файле <code>/etc/hosts</code> мы можем переопределить адрес DNS любых доменов. Постоянно используется для локальной разработки.</p> <p><a href="https://howdns.works/" target="_blank" rel="noopener noreferrer">Утю-тю, атя-тя комикс про DNS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="tcp"><a href="#tcp" aria-hidden="true" class="header-anchor">#</a> TCP</h3> <p><a href="https://stepik.org/lesson/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D1%8B-14823/step/4?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4172" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>IP не реализует передачу данных без потерь и способен передавать данные только между машинами, но не между программами.</p> <p>TCP - протокол, обеспечивающий надежную последовательную доставку данных. Фактически, TCP предоставляет интерфейс, похожий на файловый ввод/вывод для сетевых соединений.</p> <ul><li>Надежная доставка (убеждается, что все доставил, а не просто передает)</li> <li>Полнодуплексная передача (и от клиента к серверу и от сервера клиенту)</li> <li>Контроль потока - защита от переполнения</li></ul> <h4 id="порты"><a href="#порты" aria-hidden="true" class="header-anchor">#</a> Порты</h4> <p>TCP порт — это «адрес» сетевого соединения в пределах одного хоста. TCP порты позволяют поддерживать множество открытых соединений на одной машине.</p> <p>Номер порта — целое число, не больше 65535. Порты ниже 1024 требуют привилегий суперпользователя.</p> <p>Порты решают задачу передачу данных для конкретной программы, а не просто машине. Каждый порт связан с конкретной программой, ОС про это знает и все данные, которые передаются на этот порт, попадут в эту программу.</p> <p>Исторически некоторые порты закреплены за определенными службами:</p> <ul><li>20, 21 - FTP</li> <li>22 - SSH</li> <li>25 - SMTP</li> <li>80 - HTTP</li> <li>443 - HTTPS</li></ul> <p>Сокет — это IP-адрес с портом («гнездо», соответствующее адресу и порту). Сокеты могут быть серверные (получатель, который слушает) и клиентские (которые отсылают данные).</p> <p>Каждый процесс может создать «слушающий» сокет (серверный сокет) и привязать его к какому-нибудь порту операционной системы (в UNIX непривилегированные процессы не могут использовать порты меньше 1024). Слушающий процесс обычно находится в цикле ожидания, то есть просыпается при появлении нового соединения. При этом сохраняется возможность проверить наличие соединений на данный момент, установить тайм-аут для операции и т. д.</p> <h2 id="tls-протокоn"><a href="#tls-протокоn" aria-hidden="true" class="header-anchor">#</a> TLS-протокол</h2> <p><a href="https://stepik.org/lesson/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB%D1%8B-14823/step/5?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4172" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>TLS (Transport Layer Security, ранее SSL) - криптографический протокол, обеспечивающий безопасную передачу данных между хостами в Internet.</p> <p>TCP обеспечивает надежную доставку (ничего не потеряется), TLP обеспечивает безопасную доставку (никто не узнает, что передаем).</p> <ul><li>Аутентификация сервера (и клиента)</li> <li>Шифрование и сжатие передаваемой информации</li> <li>Защита от подмены и проверка целостности сообщений</li></ul> <h2 id="итого-по-установке-соединения"><a href="#итого-по-установке-соединения" aria-hidden="true" class="header-anchor">#</a> Итого по установке соединения</h2> <p>Для того, чтобы получить страничку при вводе урла в браузер нам нужно опросить ряд DNS-серверов (или один, если запрос закэширован), установить TCP-соединение (1 <a href="https://ru.wikipedia.org/wiki/%D0%9A%D1%80%D1%83%D0%B3%D0%BE%D0%B2%D0%B0%D1%8F_%D0%B7%D0%B0%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B0" target="_blank" rel="noopener noreferrer">RTT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) и часто еще и TLP-соединение (1-2 RTT).</p> <p>RTT — это время, затраченное на отправку сигнала, плюс время, которое требуется для подтверждения, что сигнал был получен.</p> <h1 id="протокоn-http"><a href="#протокоn-http" aria-hidden="true" class="header-anchor">#</a> Протокол HTTP</h1> <h2 id="назначение"><a href="#назначение" aria-hidden="true" class="header-anchor">#</a> Назначение</h2> <p>Взаимодействие по HTTP начинается после установки соединения по TCP/TLS.</p> <p>Hyper Text Transfer Protocol — протокол для передачи гипертекста (HTML).</p> <p>Многие задачи не решены на уровне TCP и нужен протокол более высокого уровня.</p> <p>HTTP решает следующие задачи:</p> <ul><li>Передача документов (TCP устанавливает потоковую передачу байт. В нем нельзя узнать, когда документ закончился).</li> <li>Передача мета-информации (mime-type, размер документа)</li> <li>Авторизация</li> <li>Поддержка сессий. HTTP работает по принципу &quot;вопрос-ответ&quot;. Поэтому нужен какой-то механизм поддержки состояния. Клиент может получать данные каждый раз с разных серверов. Чтобы рассказать, что клиент &quot;свой&quot; данные передаются в заголовках запросов.</li> <li>Кеширование документов (стили, скрипты, шрифты, картинки и пр.)</li> <li>Согласование содержимого (negotiation)</li> <li>Управление соединением. TCP можно только закрыть, в HTTP можно более гибко управлять: закрыть, оставить.</li></ul> <h2 id="http-запрос"><a href="#http-запрос" aria-hidden="true" class="header-anchor">#</a> HTTP-запрос</h2> <p>Запрос — это текст. Увидеть можно из консоли: <code>curl -v ya.ru</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> GET /index.html HTTP/1.1
<span class="token operator">&gt;</span> Host: oggettoweb.ru
<span class="token operator">&gt;</span> User-Agent: curl/7.43.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
</code></pre></div><p><code>GET /index.html HTTP/1.1</code> — строка запроса: метод, урл и версия протокола. <code>GET</code> — метод запроса. Говорим серверу, что мы хотим от него.</p> <p>Далее идут заголовки вида <code>Ключ: Значение</code>. Например, <code>Host: oggettoweb.ru</code>.</p> <p>Заголовки могут быть любыми, главное, чтобы они соответствовали <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" target="_blank" rel="noopener noreferrer">спецификации<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (не содержали переводов строк и пр.)</p> <p>После заголовков идет пустая строка. Она отмечает конец заголовков и поле нее может быть тело запроса, если надо.</p> <p>Запрос — это просто текст, написанный по определенным правилам. В этом легко убедится с помощью утилиты <code>nc</code>.</p> <p>Создадим файл <code>myget</code>, в котором запишем запрос:</p> <div class="language- extra-class"><pre class="language-text"><code>GET /index.html HTTP/1.1
Host: oggettoweb.ru

</code></pre></div><p>Далее передадим его содержимое в команду <code>nc</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> myget <span class="token operator">|</span> <span class="token function">nc</span> oggettoweb.ru 80
</code></pre></div><p>Мы получим документ, который запросили.</p> <p>Вместо <code>GET</code> можно написать <code>HEAD</code> и получить только заголовки документа без тела. Подходит для проверки наличия документа, часто используется роботами.</p> <h2 id="http-ответ"><a href="#http-ответ" aria-hidden="true" class="header-anchor">#</a> HTTP-ответ</h2> <p>Ответ — текст, который разбирается клиентами.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt; HTTP/1.1 200 OK
&lt; Server: nginx
&lt; Date: Tue, 06 Sep 2016 04:42:23 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 10894
&lt; Last-Modified: Fri, 02 Sep 2016 12:07:22 GMT
&lt; Connection: keep-alive
&lt; Vary: Accept-Encoding
&lt; Accept-Ranges: bytes
&lt; 
&lt;!DOCTYPE html&gt;...
</code></pre></div><p>Клиент и сервер выбирают ту версию HTTP, которая поддерживается обоими. Если клиент работает по HTTP1.1, а сервер понимает только HTTP1.0, то будет использован 1.0.</p> <p><code>HTTP/1.1 200 OK</code> — 200 — код ответа. Результат операции. ПО ориентируется на число, текст после него больше для человека и особой технической роли не играет.</p> <p><code>Content-Type: text/html</code> нужен браузеру обязательно. Без него он не отобразит документ. Остальные заголовки не так важны.</p> <p>Длина документа задается как <code>Content-Length: 10894</code>. Соединение при этом можно оставить открытым: <code>Connection: keep-alive</code>. Иногда просто считывается, пока соединение не будет закрыто: <code>Connection: close</code>.</p> <h2 id="методы-http-запросов"><a href="#методы-http-запросов" aria-hidden="true" class="header-anchor">#</a> Методы HTTP-запросов</h2> <p>Основные:</p> <ul><li><code>GET</code> — получить документ.</li> <li><code>HEAD</code> — получить только заголовки.</li> <li><code>POST</code> — отправка произвольных данных на сервер.</li></ul> <p>Не так часто используются, как правило отключены на публичных серверах и используются во внутренней логике работы веб-приложения:</p> <ul><li><code>PUT</code> - отправка документа на сервер</li> <li><code>DELETE</code> - удаление документа</li> <li><code>CONNECT</code>, <code>TRACE</code>, <code>OPTIONS</code> - используются редко</li> <li><code>COPY</code>, <code>MOVE</code>, <code>MKCOL</code> - WebDAV (расширение протокола HTTP, для управления файлами)</li></ul> <h2 id="коды-http-ответов"><a href="#коды-http-ответов" aria-hidden="true" class="header-anchor">#</a> Коды HTTP-ответов</h2> <p>Коротко:</p> <blockquote><p><a href="https://twitter.com/thecrunsher/status/1111258419087007745?ref_src=twsrc%5Etfw" style="color: #999; text-decoration: underline;">Quick guide</a> to HTTP Status codes:<br> <b>1XX</b>: Wait a sec<br> <b>2XX</b>: There ya go<br> <b>3XX</b>: Fuck off<br> <b>4XX</b>: Fuck you<br> <b>5XX</b>: Fuck</p></blockquote> <p>Чуть подробнее:</p> <ul><li><code>1xx</code> — информационные.</li> <li><code>2xx</code> — успешное выполнение:
<ul><li>200 OK — запрос успешно выполнен.</li> <li>204 No Content — запрос успешно выполнен, но документ пуст.</li></ul></li> <li><code>3xx</code> — перенаправления:
<ul><li>301 Moved Permanently — документ сменил URL. Документ навсегда перенесен, сервер настроить так, чтобы выдавал 302 и браузер дальше ходит по новому урлу.</li> <li>302 Found — повторить запрос по другому URL. Документ временно перенесен и кешировать новый урл не надо. Используется для предотвращения повторной отправки форм.</li> <li>304 Not Modified — документ не изменился, использовать кеш.</li></ul></li> <li><code>4xx</code> — ошибка на стороне клиента:
<ul><li>400 Bad Request — неправильный синтаксис запроса.</li> <li>401 Unauthorized — требуется авторизация.</li> <li>403 Forbidden — нет доступа (неверная авторизация).</li> <li>404 Not Found — документ не найден.</li></ul></li> <li><code>5xx</code> — ошибка на стороне сервера:
<ul><li>500 Internal Server Error — неожиданная ошибка сервера (application).</li> <li>502 Bad Gateway — проксируемый сервер отвечает с ошибкой.</li> <li>504 Gateway Timeout — проксируемый сервер не отвечает.</li></ul></li></ul> <p>См. также <a href="https://http.cat" target="_blank" rel="noopener noreferrer">http.cat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <p><img src="https://http.cat/404" alt></p> <h2 id="загоnовки"><a href="#загоnовки" aria-hidden="true" class="header-anchor">#</a> Заголовки</h2> <p>С помощью заголовков устанавливаются опции протокола.</p> <p>Общие для запросов и ответов. Как правило управляют соединением или содержимым тела запроса:</p> <ul><li>Content-Type - MIME тип документа</li> <li>Content-Length - длина сообщения</li> <li>Content-Encoding - кодирование документа, например gzip-сжатие</li> <li>Transfer-Encoding - формат передачи, например, chunked</li> <li>Connection - управление соединением</li> <li>Upgrade - смена протокола</li></ul> <p>Только в запросах:</p> <ul><li>Authorization - авторизация, чаще всего логин/пароль</li> <li>Cookie - передача состояния (сессии) на сервер.</li> <li>Referer - URL предыдущего документа, контекст запроса</li> <li>User-Agent - описание web-клиента, версия браузера</li> <li>If-Modified-Since - условный GET запрос</li> <li>Accept-* - согласование (negotiation) содержимого</li></ul> <p>Только в ответах:</p> <ul><li>Location - новый URL документа при перенаправлениях</li> <li>Set-Cookie - установка состояния (сессии) в браузере</li> <li>Last-Modified - дата последнего изменения документа</li> <li>Date - Дата на сервере, для согласования кешей</li> <li>Server - описание web-сервера, название и версия</li></ul> <p>Механизм сессии: Юзер авторизуется, после авторизации сервер педает клиенту ключ в <code>Set-Cookie</code> и потом клиент этот ключ передает серверу каждый раз при запросах.</p> <h2 id="управnение-соединением-в-http1-1"><a href="#управnение-соединением-в-http1-1" aria-hidden="true" class="header-anchor">#</a> Управление соединением в HTTP1.1</h2> <p>Протокол HTTP/1.0 предполагает закрытие TCP соединения сразу после ответа сервера.</p> <p>Протокол HTTP/1.1 предполагает удержание TCP соединения, если не было заголовка <code>Connection: close</code>.</p> <p>Соединение должно быть закрыто, если:</p> <ul><li>cервер или клиент использует HTTP младше 1.1</li> <li>cервер или клиент передал заголовок <code>Connection: close</code></li> <li>по истечении таймаута (обычно небольшой, около 10с)</li></ul> <p>Иначе соединение остается открытым для последующих запросов.</p> <p>Основная задача такого соединения — загрузить все ресурсы для странички за одно соединение по TCP. Живет оно недолго, порядка 10 секунд. То есть это не полноценное персистентное (постоянное) соединение.</p> <p>См. также курс <a href="https://ru.hexlet.io/courses/http_protocol" target="_blank" rel="noopener noreferrer">Протокол HTTP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> на Хекслете.</p> <h1 id="веб-сервер"><a href="#веб-сервер" aria-hidden="true" class="header-anchor">#</a> Веб-сервер</h1> <p><a href="https://stepik.org/lesson/Web-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-14825/step/2?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4174" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Занимается обработкой протокола HTTP (отдачей документов веб-клиентам).</p> <p>Веб-сервер — это демон — программа, не связанная с консолью или GUI. Она висит в памяти и обрабатывает данные, которые приходят по сети, через <a href="https://ru.wikipedia.org/wiki/%D0%A1%D0%BE%D0%BA%D0%B5%D1%82_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BD%D1%8B%D0%B9_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81)" target="_blank" rel="noopener noreferrer">сокеты<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (IP + порт в TCP/IP).</p> <h2 id="примеры"><a href="#примеры" aria-hidden="true" class="header-anchor">#</a> Примеры</h2> <p>Apache — самый распространенный. Написан давно, много переписывался (Apache похоже на Patch).</p> <p>Nginx (эндженикс) — разработал <a href="https://ru.wikipedia.org/wiki/%D0%A1%D1%8B%D1%81%D0%BE%D0%B5%D0%B2,_%D0%98%D0%B3%D0%BE%D1%80%D1%8C_%D0%92%D0%BB%D0%B0%D0%B4%D0%B8%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B8%D1%87_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82)" target="_blank" rel="noopener noreferrer">Игорь Сысоев<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Более легковесный, быстрый и надежный. Быстро набирает популярность.</p> <h2 id="запуск"><a href="#запуск" aria-hidden="true" class="header-anchor">#</a> Запуск</h2> <p>Nginx запускается инит-скриптом. Примерно так: <code>/etc/init.d/nginx start</code>. Инит скрипт создается тем, кто выкладывает пакет в пакетный менеджер. Там происходит много всего и нам как пользователям это не интересно.</p> <p>При запуске демона он читает файл конфигурации (<code>nginx.conf</code>). И подтягивает конфиги всех виртуальных хостов.</p> <p>Далее он получает 80-й порт, который нужен для обработки HTTP. Порты ниже 1024 требуют привилегий супер-юзера. Для прослушивания 80-го порта нужно запускать сервер под <code>sudo</code> (с привилегиями супер-пользователя).</p> <p>Сервер пишет логи. Куда — это прописано в конфиге сайтов и дефолтном конфиге сервера.</p> <p>Далее сервер понижает привилегии, чтобы он работал не от супер-юзера. Он запускает дочерние процессы (воркеры или потоки).</p> <h2 id="файnы-которые-испоnьзует-веб-сервер"><a href="#файnы-которые-испоnьзует-веб-сервер" aria-hidden="true" class="header-anchor">#</a> Файлы, которые использует веб-сервер</h2> <p>Конфиг: <code>/etc/nginx/nginx.conf</code></p> <p>Как правило в конфиге встречается подключение сторониих файлов:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>sites<span class="token operator">-</span>enabled<span class="token operator">/</span><span class="token operator">*</span>
</code></pre></div><p>При инициализации они тоже становятся частью конфигурации.</p> <p>Инит-скрипт: <code>/etc/init.d/nginx [start|stop|restart]</code></p> <p>PID-файл — файл идентификатора процесса: <code>/var/run/nginx.pid</code>. Демоны отключаются от консоли после запуска. Этот файл нужен для идентификации процесса демона, чтобы к нему можно было обратится (остановить, перезапустить и пр.).</p> <p>Error-лог: <code>/var/log/nginx/error.log</code> — ошибки сервера. Формат отличается для разных серверов, не формализован.</p> <p>Access-лог: <code>/var/log/nginx/access.log</code> — обработка про обработанные HTTP-запросы. Жесткий формат лога, можно обрабатывать программно.</p> <p>Логи удобнее задавать для каждого проекта в его же папке.</p> <h2 id="процессы-веб-сервера"><a href="#процессы-веб-сервера" aria-hidden="true" class="header-anchor">#</a> Процессы веб-сервера</h2> <p>Выделяются 2 вида процессов: Master и Worker.</p> <p>Мастер-процесс запускается инит-скриптом под <code>root</code>. Мастер-процесс один. Он читает и проверяет конфиг, открывает логи и сокеты (порты), запускает дочерние процессы (воркеры) и управляет ими. После этого мастер-процесс переходит в режим мониторинга.</p> <p>Воркер запускается с пониженными привилегиями (например, юзер может называется <code>www-data</code> или <code>nobody</code>). Воркеров может быт столько, сколько нужно для работы сервера (зависит от модели сетевых соединений, которые использует сервер). Они занимаются обработкой входящих запросов.</p> <p>Бывают дополнительные процессы. Например, кэш-менеджеры, которые следят за очисткой кэша.</p> <h2 id="цикn-работы-воркер-процессов"><a href="#цикn-работы-воркер-процессов" aria-hidden="true" class="header-anchor">#</a> Цикл работы воркер-процессов</h2> <p>Воркер-процессы работают в цикле. На рисунке процесс начинается сверху:</p> <img src="/frontend-handbook/assets/img/workers_cycle.7077f0e9.png" style="max-width: 700px"> <p>После установки соединения воркер читает HTTP-запрос.</p> <h2 id="модуnьная-архитектура-сервера"><a href="#модуnьная-архитектура-сервера" aria-hidden="true" class="header-anchor">#</a> Модульная архитектура сервера</h2> <p><a href="https://stepik.org/lesson/Web-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-14825/step/3?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4174" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Nginx нужно скомпилировать с поддержкой какого-то нужного модуля. В Apache модули можно подгружать динамически.</p> <p>Модуль добавляет директивы в конфиг сервера и регистрирует свои обработчики на этапе цикла работы воркеров.</p> <p>Пример: <code>mod_gzip</code>.</p> <h2 id="конфигурация-веб-сервера"><a href="#конфигурация-веб-сервера" aria-hidden="true" class="header-anchor">#</a> Конфигурация веб-сервера</h2> <p><a href="https://stepik.org/lesson/Web-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-14825/step/4?course=Web-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8&unit=4174" target="_blank" rel="noopener noreferrer">Видео<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Виртуальный хост (virtual host) — секция конфига, отвечающая за обслуживание определенного домена. Почти всегда сервер обрабатывает несколько разных доменов.</p> <p>Location — секция конфига, отвечающая за обработку набора урлов. Группа урлов — набор определенного типа документов. Их можно обобщать в этой секции конфига.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">user</span> www www<span class="token punctuation">;</span> <span class="token comment"># Имя пользователя и группа для воркеров</span>
<span class="token keyword">error_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">error_log</span> info<span class="token punctuation">;</span> <span class="token comment"># адрес файла и уровень ошибок</span>

<span class="token comment"># Эта секция — конфиг веб-сервера.</span>
<span class="token comment"># Кроме http Nginx может работать как Proxy и как почтовый сервер</span>
<span class="token keyword">http</span> <span class="token punctuation">{</span> <span class="token comment"># Контейнер для настроек всего http-сервера</span>
    <span class="token keyword">include</span> conf<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">default_type</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    <span class="token keyword">log_format</span> simple <span class="token string">'$remote_addr $request $status'</span><span class="token punctuation">;</span>

    <span class="token comment"># До этого момента директивы относились ко всем хостам.</span>
    <span class="token comment"># Далее идут специфичные настройки для доменов: </span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span> <span class="token comment"># Контейнер для настроек виртуального хоста</span>
        <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>

        <span class="token comment"># Имена доменов</span>
        <span class="token keyword">server_name</span> one<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com www<span class="token punctuation">.</span>one<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

        <span class="token comment"># Лог-файл для домена</span>
        <span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">access_log</span> simple<span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span> <span class="token comment"># любой урл</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>one<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span> <span class="token comment"># откуда брать файлы</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span> <span class="token comment"># картинки</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>images<span class="token punctuation">;</span> <span class="token comment"># откуда брать файлы</span>
            <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
            <span class="token keyword">expires</span> <span class="token number">30</span>d<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>См. также <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/" target="_blank" rel="noopener noreferrer">частые ошибки в конфигах<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="приоритет-урnов-в-location"><a href="#приоритет-урnов-в-location" aria-hidden="true" class="header-anchor">#</a> Приоритет урлов в location</h2> <p>Следующие типы location расположены в порядке уменьшения приоритета:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>img<span class="token operator">/</span><span class="token number">1.</span>jpg <span class="token comment"># четкое совпадение</span>
<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>pic<span class="token operator">/</span>     <span class="token comment"># приоритетное совпадение по префиксу (начало урла)</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span>jpg$    <span class="token comment"># по регулярному выражению</span>
<span class="token keyword">location</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>img<span class="token operator">/</span>        <span class="token comment"># совпадение по префиксу</span>
</code></pre></div><p>Соответственно, в примере <code>location ~* ^.+\.(jpg|jpeg|gif)$</code> перебьет <code>location /</code>.</p> <p>При одинаковых приоритетах выбирается <code>location</code>, который в конфиге расположен <strong>выше</strong>. Конфиг — это не программа, которая обрабатывается строка-за-строкой. В итоге конфиг превращается в плоскую структуру директив для доменов и последовательность в ней роли не играет.</p> <h2 id="отдача-статических-документов"><a href="#отдача-статических-документов" aria-hidden="true" class="header-anchor">#</a> Отдача статических документов</h2> <p>Нужно сопоставить урлы из HTTP-запросов с файлами:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">root</span> <span class="token operator">/</span><span class="token keyword">User</span><span class="token operator">/</span>amiskov<span class="token operator">/</span>Sites<span class="token operator">/</span>project<span class="token operator">/</span>images<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> <span class="token operator">/</span>sitemap<span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">alias</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>generated<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Если задан <code>root</code>, то путь из урла склеится с <code>root</code>:</p> <p><code>/slider/banner.jpg</code> =&gt; <code>/User/amiskov/Sites/project/images/banner.jpg</code></p> <p>Если задан <code>alias</code>, то путь из <code>location</code> подменится алиасом:</p> <p><code>/sitemap/index.xml</code> =&gt; <code>/home/generated/index.xml</code></p> <p>Алиас будет работать только по префиксу. А регуляркой не получится.</p> <h2 id="атрибуты-файnов-и-процессов"><a href="#атрибуты-файnов-и-процессов" aria-hidden="true" class="header-anchor">#</a> Атрибуты файлов и процессов</h2> <p>После того, как сервер понял, какой файл отдавать, он проверяет права доступа на файловой системе. Если нет прав на отдачу, то будет ошибка с кодом <code>403</code>.</p> <p>У каждого процесса есть свой пользователь и группа.</p> <p><code>ps aux | grep nginx</code> — посмотреть все запущенные процессы nginx.</p> <p>У файла (каталога) есть так же пользователь (владелец) и группа. И еще права доступа (read, write, execute).</p> <p><code>ls -la</code> — показать файловую систему с указанием владельцев и уровней доступа.</p> <p>Чтобы сервер смог открыть файл, у него должны быть права на чтение файла (<code>r</code>) и на исполнение каталога (<code>x</code>), где этот файл лежит.</p> <p>Права распределяются по тройкам <code>rwxrwxrwx</code>: user, group, everyone.</p> <p>Если пользователь процесса совпадает с пользователем (владельцем) файла, то проверяется первая тройка. Иначе проверяется совпадение группы, иначе используется третья тройка.</p> <h2 id="модеnи-обработки-сетевых-соединений"><a href="#модеnи-обработки-сетевых-соединений" aria-hidden="true" class="header-anchor">#</a> Модели обработки сетевых соединений</h2> <p>Apache — изначально prefork. Запускает процессы на каждое соединение. Самый старый сервер, классика. Научился работать в режиме worker (комбинированный) и threads. Написан на C.</p> <p>Nginx — событийно ориентированный, асинхронный. Написан на C.</p> <p>NodeJS — событийно ориентированный, асинхронный, на языке высокого уровня. Относительно медленнее Nginx, но очень легко интегрируемый и расширяемый в контексте приложений на JS.</p> <h2 id="протокоn-ssh"><a href="#протокоn-ssh" aria-hidden="true" class="header-anchor">#</a> Протокол SSH</h2> <p><a href="https://ru.wikipedia.org/wiki/SSH" target="_blank" rel="noopener noreferrer">SSH<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> — защищенный протокол, который позволяет работать на удаленной машине. В командной строке можно набрать команду для соединения с указанием пользователя и хоста (<code>ssh vasya@some-server.com</code>), ввести пароль и получить доступ к командной строке удаленной ЭВМ. Часто используется системными администраторами и разработчиками для настройки удаленных серверов (конфигурирования хостинга, создания/копирования файлов и каталогов и пр.).</p> <p>По SSH работает git, когда вы пушите/пулите изменения на remote.</p> <p>Посмотрите видео «Основы SSH»:</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/sbVYRf_6Hvg" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen="allowfullscreen"></iframe> <p>Прочитайте статью «<a href="https://hexletguides.github.io/ssh/" target="_blank" rel="noopener noreferrer">Что такое SSH<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>».</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/frontend-handbook/copyright/" class="prev">
          Авторское право
        </a></span> <span class="next"><a href="/frontend-handbook/soft-skills/">
          Коммуникация, управление (soft skills)
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/frontend-handbook/assets/js/app.d98f21f9.js" defer></script><script src="/frontend-handbook/assets/js/2.c185984c.js" defer></script>
  </body>
</html>
